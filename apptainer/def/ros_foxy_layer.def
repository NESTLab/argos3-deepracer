Bootstrap: localimage
From: base_ubuntu_2004.sif

%labels
    AUTHOR khaiyichin@gmail.com
    VERSION 1.0.0
    NAME ros_foxy_layer

%help
    SUMMARY
    This container contains the installation of ROS 2 Foxy. To add this layer to
    an existing build simply modify the value for `From` above to point to an existing
    .sif file

    CHANGELOG
    v1.0.0
    Initial release.

%environment
    source /opt/ros/foxy/setup.sh

%post -c /bin/bash
    # Setup color output macro
    loginfo() {
        GREEN="\033[0;32m"
        GREENB="\033[1;32m"
        YELLOW="\033[0;33m"
        YELLOWB="\033[1;33m"
        RESET="\033[0m"

        echo -e "${!1}APPTAINER BUILD:    ${2}${RESET}"
    }

    # Prevent user prompts
    export DEBIAN_FRONTEND=noninteractive

    # Terminate on errors
    set -e

    # Update and upgrade packages
    loginfo "YELLOWB" "Updating and upgrading packages..."
    apt update && apt upgrade -qy
    
    # Install dependencies
    loginfo "YELLOWB" "Installing dependencies..."
    apt install -q -y locales curl make g++
    locale-gen en_US en_US.UTF-8
    update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8
    export LANG=en_US.UTF-8

    # Add repository to sources list
    apt install -q -y software-properties-common
    add-apt-repository universe
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" | tee /etc/apt/sources.list.d/ros2.list > /dev/null

    # Install ROS Foxy
    loginfo "YELLOWB" "Installing ROS Foxy..."
    apt update && apt upgrade -qy
    apt install -q -y ros-foxy-ros-base python3-argcomplete ros-dev-tools

    # Replace ".bash" with your shell if you're not using bash
    # Possible values are: setup.bash, setup.sh, setup.zsh
    source /opt/ros/foxy/setup.bash

    # Insert additional labels
    echo "CREATED $(date)" >> $APPTAINER_LABELS

%runscript