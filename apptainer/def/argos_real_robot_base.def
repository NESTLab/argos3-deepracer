Bootstrap: docker
From: ubuntu:20.04

%labels
    AUTHOR khaiyichin@gmail.com
    VERSION 1.0.0
    NAME argos_real_robot_base

%help
    SUMMARY
    This container contains an installation of ARGoS on a real robot. Build this
    image with the argument `ARGOS_BUILD_FOR=<ROBOT-NAME>`.

    CHANGELOG
    v1.0.0
    Initial release.

%arguments
    ARGOS_BUILD_FOR=null

%post -c /bin/bash
    # Setup color output macro
    loginfo() {
        GREEN="\033[0;32m"
        GREENB="\033[1;32m"
        YELLOW="\033[0;33m"
        YELLOWB="\033[1;33m"
        RESET="\033[0m"

        echo -e "${!1}APPTAINER BUILD:    ${2}${RESET}"
    }

    # Prevent user prompts
    export DEBIAN_FRONTEND=noninteractive

    # Terminate on errors
    set -e

    # Update and upgrade packages
    loginfo "YELLOWB" "Updating and upgrading packages..."

    apt update && apt upgrade -qy

    # Install dependencies
    loginfo "YELLOWB" "Installing dependencies..."

    apt install -qy git wget build-essential cmake libfreeimage-dev libfreeimageplus-dev \
        qt5-default freeglut3-dev libxi-dev libxmu-dev liblua5.3-dev \
        lua5.3 doxygen graphviz libgraphviz-dev asciidoc

    # Install ARGoS
    loginfo "YELLOWB" "Installing ARGoS for {{ARGOS_BUILD_FOR}}..."

    git clone https://github.com/ilpincy/argos3 argos3
    pushd argos3
    mkdir build && cd build
    cmake -DCMAKE_BUILD_TYPE=Release \
      -DARGOS_BUILD_FOR={{ARGOS_BUILD_FOR}} \
      -DARGOS_DOCUMENTATION=OFF \
      -DARGOS_BUILD_NATIVE=ON \
      ../src
    make -j$(nproc)
    make install
    ldconfig
    popd

    # Remove files
    loginfo "YELLOWB" "Removing unneeded files and folders..."

    rm -rf argos3

    # Insert additional labels
    echo "CREATED $(date)" >> $APPTAINER_LABELS