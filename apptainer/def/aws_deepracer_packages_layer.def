Bootstrap: localimage
From: ros_foxy_layer.sif

%labels
    AUTHOR khaiyichin@gmail.com
    VERSION 1.0.0
    NAME aws_deepracer_layer

%help
    SUMMARY
    This container contains the installation of AWS Deepracer Packages. ROS 2 is required
    for this image to build. To add this layer to an existing build simply modify the
    value for `From` above to point to an existing .sif file.

    CHANGELOG
    v1.0.0
    Initial release.

%environment
    source /opt/ros/foxy/setup.sh
    source /deepracer_nav2_ws/aws-deepracer/install/setup.sh

%post -c /bin/bash
    # Setup color output macro
    loginfo() {
        GREEN="\033[0;32m"
        GREENB="\033[1;32m"
        YELLOW="\033[0;33m"
        YELLOWB="\033[1;33m"
        RESET="\033[0m"

        echo -e "${!1}APPTAINER BUILD:    ${2}${RESET}"
    }

    # Prevent user prompts
    export DEBIAN_FRONTEND=noninteractive

    # Terminate on errors
    set -e

    # Update and upgrade packages
    loginfo "YELLOWB" "Updating and upgrading packages..."
    apt update && apt upgrade -qy
    
    # Install dependencies
    loginfo "YELLOWB" "Installing dependencies..."
    apt install -qy ros-foxy-navigation2 ros-foxy-nav2-bringup python3-rosinstall

    # Install AWS packages
    loginfo "YELLOWB" "Installing AWS DeepRacer packages..."
    mkdir -p /deepracer_nav2_ws
    cd /deepracer_nav2_ws
    git clone https://github.com/aws-deepracer/aws-deepracer.git
    
    cd /deepracer_nav2_ws/aws-deepracer/deepracer_nodes
    git clone https://github.com/MAPIRlab/rf2o_laser_odometry.git    
    cd /deepracer_nav2_ws/aws-deepracer/deepracer_nodes/rf2o_laser_odometry
    git fetch origin pull/29/head:foxy-devel
    git checkout foxy-devel

    cd /deepracer_nav2_ws/aws-deepracer/deepracer_nodes
    git clone https://github.com/Slamtec/rplidar_ros.git -b ros2

    # Fetch unreleased dependencies
    source /opt/ros/foxy/setup.bash 
    cd /deepracer_nav2_ws/aws-deepracer/deepracer_nodes
    rosws update

    # Build robot packages
    pushd /deepracer_nav2_ws/aws-deepracer/
    colcon build --packages-select deepracer_interfaces_pkg deepracer_bringup \
        cmdvel_to_servo_pkg enable_deepracer_nav_pkg rf2o_laser_odometry

    # Insert additional labels
    echo "CREATED $(date)" >> $APPTAINER_LABELS

%runscript